<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Xiangyee Hunan Cuisine | Receipt</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
          colors: { brand: { red: '#dc2626' } }
        }
      }
    }
  </script>

  <style>
    html { scroll-behavior: smooth; }
    .shadow-soft { box-shadow: 0 10px 30px rgba(0,0,0,.08); }
  </style>
</head>

<body class="bg-neutral-50 text-neutral-900 font-sans">
  <!-- Header -->
  <header class="sticky top-0 z-50 bg-white/80 backdrop-blur border-b border-neutral-200">
    <div class="max-w-3xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="/" class="flex items-center gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-brand-red">
          <path d="M7.5 6.75a.75.75 0 0 1 .75-.75h7.5a.75.75 0 0 1 .75.75v.75H7.5v-.75ZM6 9h12l-.75 9a2.25 2.25 0 0 1-2.244 2.063H8.994A2.25 2.25 0 0 1 6.75 18L6 9Z"/>
        </svg>
        <span class="font-extrabold tracking-wide text-lg">Xiangyee Hunan Cuisine</span>
      </a>

      <a href="/#my-order"
         class="px-4 py-2 rounded-xl border border-neutral-300 bg-white font-semibold hover:border-brand-red hover:text-brand-red">
        Back to My Order
      </a>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-3xl mx-auto px-4 py-10 md:py-14">
    <!-- Loading -->
    <div id="loading" class="rounded-2xl border border-neutral-200 bg-white shadow-soft p-8">
      <div class="animate-pulse space-y-3">
        <div class="h-6 bg-neutral-200 rounded w-2/3"></div>
        <div class="h-4 bg-neutral-200 rounded w-1/2"></div>
        <div class="h-4 bg-neutral-200 rounded w-1/3"></div>
        <div class="h-28 bg-neutral-200 rounded"></div>
      </div>
      <p class="mt-4 text-sm text-neutral-500">Loading your receipt…</p>
    </div>

    <!-- Error -->
    <div id="error" class="hidden rounded-2xl border border-red-200 bg-red-50 p-6 text-red-800">
      <div class="font-bold text-lg">Receipt not available</div>
      <p id="error-msg" class="mt-2 text-sm text-red-700"></p>
      <div class="mt-4 flex flex-wrap gap-3">
        <a href="/#my-order"
           class="px-4 py-2 rounded-xl bg-black text-white font-semibold hover:bg-neutral-800">
          Go to My Order
        </a>
        <a href="/"
           class="px-4 py-2 rounded-xl border border-neutral-300 bg-white font-semibold hover:border-brand-red hover:text-brand-red">
          Home
        </a>
      </div>
    </div>

    <!-- Receipt -->
    <section id="receipt" class="hidden">
      <div class="rounded-2xl border border-neutral-200 bg-white shadow-soft overflow-hidden">
        <!-- Top -->
        <div class="p-6 md:p-8 border-b border-neutral-200">
          <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
            <div>
              <div class="text-sm tracking-widest uppercase text-brand-red font-semibold">Receipt</div>
              <h1 class="text-2xl md:text-3xl font-extrabold mt-1">Thank you for dining with us!</h1>
              <p class="text-neutral-600 mt-2">
                Please keep this receipt for reference.
              </p>
            </div>

            <div class="md:text-right">
              <div class="text-sm text-neutral-500">Order Number</div>
              <div id="r-order-no" class="text-2xl font-black tracking-widest">—</div>

              <div class="mt-3 text-sm text-neutral-500">Status</div>
              <div id="r-status" class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-semibold bg-neutral-100 text-neutral-800">
                —
              </div>
            </div>
          </div>

          <div class="mt-6 grid sm:grid-cols-2 gap-4 text-sm">
            <div class="rounded-xl bg-neutral-50 border border-neutral-200 p-4">
              <div class="text-neutral-500">Customer</div>
              <div id="r-customer" class="mt-1 font-semibold">—</div>
              <div id="r-phone" class="text-neutral-600 mt-1">—</div>
            </div>

            <div class="rounded-xl bg-neutral-50 border border-neutral-200 p-4">
              <div class="text-neutral-500">Order details</div>
              <div id="r-type" class="mt-1 font-semibold">—</div>
              <div id="r-table" class="text-neutral-600 mt-1">—</div>
              <div id="r-time" class="text-neutral-600 mt-1">—</div>
            </div>
          </div>

          <div id="r-notes-wrap" class="hidden mt-4 rounded-xl bg-amber-50 border border-amber-200 p-4 text-sm">
            <div class="font-semibold text-amber-900">Notes</div>
            <div id="r-notes" class="mt-1 text-amber-900/90"></div>
          </div>
        </div>

        <!-- Items -->
        <div class="p-6 md:p-8">
          <div class="flex items-center justify-between">
            <div class="text-lg font-bold">Items</div>
            <div class="text-sm text-neutral-600">
              Total: <span id="r-total" class="font-bold">$0.00</span>
            </div>
          </div>

          <div class="mt-4 divide-y divide-neutral-100" id="r-items">
            <!-- items injected -->
          </div>

          <div class="mt-6 rounded-xl border border-neutral-200 bg-neutral-50 p-4 text-sm">
            <div class="font-semibold">Need help?</div>
            <div class="text-neutral-700 mt-1">
              Show your order number at the counter if you need assistance.
            </div>
          </div>
        </div>
      </div>

      <div class="mt-6 flex flex-wrap gap-3">
        <a href="/"
           class="px-4 py-2 rounded-xl bg-brand-red text-white font-semibold hover:bg-red-700">
          Back to Home
        </a>
        <a href="/#menu"
           class="px-4 py-2 rounded-xl border border-neutral-300 bg-white font-semibold hover:border-brand-red hover:text-brand-red">
          Order Again
        </a>
      </div>
    </section>
  </main>

  <footer class="border-t border-neutral-200 bg-white">
    <div class="max-w-3xl mx-auto px-4 py-8 text-sm text-neutral-600">
      © <span id="year"></span> Xiangyee Hunan Cuisine. All rights reserved.
    </div>
  </footer>

  <script>
    // ====== CONFIG ======
    const API_BASE = "/api";
    const ASSET_BASE = location.origin;

    const money = (n) => `$${Number(n || 0).toFixed(2)}`;

    const LAST_ORDER_KEY = "xiangyee_last_order";
    function loadLastOrder() {
      try { return JSON.parse(localStorage.getItem(LAST_ORDER_KEY)) || null; }
      catch { return null; }
    }

    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    function setStatusBadge(el, statusRaw) {
      const status = String(statusRaw || "pending").toLowerCase();
      el.className = "inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm font-semibold";

      if (status === "ready") {
        el.classList.add("bg-green-100", "text-green-800");
        el.innerHTML = `Ready to collect <span class="inline-block">✅</span>`;
      } else if (status === "collected") {
        el.classList.add("bg-neutral-900", "text-white");
        el.textContent = "Collected ✅";
      } else {
        el.classList.add("bg-amber-100", "text-amber-800");
        el.textContent = "Preparing";
      }
    }

    async function fetchOrderById(orderId) {
      const res = await fetch(`${API_BASE}/orders/${encodeURIComponent(orderId)}`);
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.error || err.message || "Order not found");
      }
      return res.json();
    }

    function normalizeOrderType(order_type) {
      const t = String(order_type || "").toLowerCase();
      if (t === "dine_in") return "Dine In";
      if (t === "takeaway") return "Takeaway";
      return order_type || "—";
    }

    function toPrettyTime(dt) {
      if (!dt) return "—";
      try { return new Date(dt).toLocaleString(); }
      catch { return String(dt); }
    }

    function renderReceipt(order) {
      document.getElementById("r-order-no").textContent = order.order_no || `#${order.id}`;

      const statusEl = document.getElementById("r-status");
      setStatusBadge(statusEl, order.status);

      const name = order.customer_name || "—";
      const phone = order.customer_phone ? String(order.customer_phone) : "—";
      document.getElementById("r-customer").textContent = name;
      document.getElementById("r-phone").textContent = phone;

      document.getElementById("r-type").textContent = `Order Type: ${normalizeOrderType(order.order_type)}`;

      const tableNo = order.table_no ? String(order.table_no) : "";
      document.getElementById("r-table").textContent =
        (String(order.order_type || "").toLowerCase() === "dine_in" && tableNo)
          ? `Table No: ${tableNo}`
          : "Table No: —";

      const time = order.updated_at || order.created_at || null;
      document.getElementById("r-time").textContent = `Time: ${toPrettyTime(time)}`;

      const notes = (order.notes || "").trim();
      const notesWrap = document.getElementById("r-notes-wrap");
      if (notes) {
        notesWrap.classList.remove("hidden");
        document.getElementById("r-notes").textContent = notes;
      } else {
        notesWrap.classList.add("hidden");
      }

      const itemsRoot = document.getElementById("r-items");
      itemsRoot.innerHTML = "";

      const items = Array.isArray(order.items) ? order.items : [];
      if (!items.length) {
        itemsRoot.innerHTML = `<div class="py-4 text-sm text-neutral-500">No items found.</div>`;
      } else {
        items.forEach(it => {
          const row = document.createElement("div");
          row.className = "py-4 flex items-start justify-between gap-4";

          const name = it.name_en || it.name || `Item #${it.menu_item_id}`;
          const cn = it.name_cn ? `<div class="text-xs text-neutral-500">${it.name_cn}</div>` : "";
          const qty = Number(it.quantity || 1);

          const unit = (it.unit_price != null) ? Number(it.unit_price) : null;
          const line = (it.line_total != null) ? Number(it.line_total) :
                       (unit != null ? unit * qty : null);

          row.innerHTML = `
            <div class="min-w-0">
              <div class="font-semibold">${name}</div>
              ${cn}
              ${unit != null ? `<div class="text-xs text-neutral-500 mt-1">${money(unit)} each</div>` : ""}
            </div>

            <div class="text-right shrink-0">
              <div class="font-semibold">x${qty}</div>
              ${line != null ? `<div class="text-sm text-neutral-700 mt-1">${money(line)}</div>` : ""}
            </div>
          `;
          itemsRoot.appendChild(row);
        });
      }

      document.getElementById("r-total").textContent = money(order.total_amount || 0);
    }

    async function init() {
      document.getElementById("year").textContent = new Date().getFullYear();

      const qid = getQueryParam("order_id");
      const last = loadLastOrder();
      const orderId = qid || last?.order_id;

      const loadingEl = document.getElementById("loading");
      const errorEl = document.getElementById("error");
      const errorMsgEl = document.getElementById("error-msg");
      const receiptEl = document.getElementById("receipt");

      if (!orderId) {
        loadingEl.classList.add("hidden");
        errorEl.classList.remove("hidden");
        errorMsgEl.textContent = "Missing order_id. Please go to My Order and try again.";
        return;
      }

      try {
        const order = await fetchOrderById(orderId);
        const status = String(order.status || "").toLowerCase();
        if (status !== "collected") {
          loadingEl.classList.add("hidden");
          errorEl.classList.remove("hidden");
          errorMsgEl.textContent = "Receipt will be available after your order is marked as collected.";
          return;
        }

        renderReceipt(order);

        loadingEl.classList.add("hidden");
        errorEl.classList.add("hidden");
        receiptEl.classList.remove("hidden");
      } catch (e) {
        loadingEl.classList.add("hidden");
        errorEl.classList.remove("hidden");
        errorMsgEl.textContent = e.message || "Failed to load receipt.";
      }
    }

    init();
  </script>
</body>
</html>
