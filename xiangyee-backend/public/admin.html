<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Xiangyee Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .toast-enter { transform: translateY(10px); opacity: 0; }
    .toast-enter-active {
      transform: translateY(0);
      opacity: 1;
      transition: all 0.25s ease-out;
    }
  </style>
</head>

<body class="bg-neutral-50 text-neutral-900">
  <div class="max-w-6xl mx-auto p-6 space-y-6">

    <div class="flex items-center justify-between">
      <h1 class="text-3xl font-black">Xiangyee Admin Dashboard</h1>
      <button id="logout-btn"
        class="hidden px-3 py-2 rounded-lg border text-sm bg-white hover:bg-neutral-100">
        Logout
      </button>
    </div>

    <!-- LOGIN -->
    <section id="login-section" class="bg-white p-6 rounded-2xl border shadow">
      <h2 class="text-xl font-bold mb-3">Staff Login</h2>
      <form id="login-form" class="grid md:grid-cols-3 gap-3">
        <input name="username" required placeholder="Username" class="border p-2 rounded" />
        <input name="password" required type="password" placeholder="Password" class="border p-2 rounded" />
        <button class="bg-black text-white rounded p-2 font-semibold">Login</button>
      </form>
      <p id="login-msg" class="text-sm mt-2 text-red-600"></p>
    </section>

    <!-- CONTENT -->
    <section id="content-section" class="hidden space-y-6">

      <!-- TABS -->
      <div class="bg-white rounded-2xl border shadow">
        <div class="sticky top-0 bg-white rounded-2xl border-b p-3 flex gap-2 z-10">
          <button id="tab-orders" class="px-3 py-2 rounded-lg text-sm font-semibold bg-black text-white">Orders</button>
          <button id="tab-res" class="px-3 py-2 rounded-lg text-sm font-semibold bg-neutral-100 hover:bg-neutral-200">Reservations</button>
          <button id="tab-menu" class="px-3 py-2 rounded-lg text-sm font-semibold bg-neutral-100 hover:bg-neutral-200">Menu</button>
        </div>

        <!-- ORDERS PANEL -->
        <div id="panel-orders" class="p-6">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold">Orders</h2>
          </div>
          <div id="orders-list" class="mt-4 space-y-3"></div>
        </div>

        <!-- RESERVATIONS PANEL -->
        <div id="panel-res" class="p-6 hidden">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold">Reservations</h2>
          </div>
          <div id="res-list" class="mt-4 space-y-3"></div>
        </div>

        <!-- MENU PANEL -->
        <div id="panel-menu" class="p-6 hidden">
          <div class="flex items-center justify-between gap-3">
            <h2 class="text-xl font-bold">Menu Items</h2>
            <button id="menu-refresh" class="px-3 py-2 rounded-lg border text-sm bg-white hover:bg-neutral-100">
              Refresh
            </button>
          </div>

          <!-- Add Item -->
          <form id="menu-form" class="mt-4 grid md:grid-cols-6 gap-3 bg-white p-4 rounded-xl border">
            <input name="name_en" required placeholder="Name (EN)" class="border p-2 rounded md:col-span-2" />
            <input name="name_cn" required placeholder="Name (CN)" class="border p-2 rounded md:col-span-2" />
            <input name="price" required type="number" step="0.01" placeholder="Price" class="border p-2 rounded md:col-span-1" />
            <input name="category" placeholder="Category" class="border p-2 rounded md:col-span-1" />
            <input name="image_url" placeholder="Image URL (e.g. /menu/three-combo-marinated.jpg)" class="border p-2 rounded md:col-span-5" />
            <label class="flex items-center gap-2 text-sm md:col-span-1">
              <input type="checkbox" name="is_available" checked />
              Available
            </label>
            <button class="bg-black text-white rounded p-2 font-semibold md:col-span-6">Add Item</button>
          </form>

          <!-- Filters -->
          <div class="mt-4 bg-white p-4 rounded-xl border flex flex-col md:flex-row md:items-center gap-3">
            <div class="flex-1">
              <input id="menu-search" placeholder="Search by English/Chinese name..." class="border p-2 rounded w-full" />
            </div>

            <div class="flex gap-2 w-full md:w-auto">
              <select id="menu-category" class="border p-2 rounded w-full md:w-56">
                <option value="">All Categories</option>
              </select>

              <select id="menu-availability" class="border p-2 rounded w-full md:w-40">
                <option value="all">All</option>
                <option value="available">Available</option>
                <option value="unavailable">Unavailable</option>
              </select>
            </div>

            <div id="menu-count" class="text-sm text-neutral-600 md:text-right md:w-40">0 items</div>
          </div>

          <div class="hidden mt-3 text-sm text-neutral-600">
            Tip: ‚ÄúRemove‚Äù will hide it (set unavailable) so old orders don‚Äôt break.
          </div>

          <div id="menu-list" class="mt-4 space-y-3"></div>
        </div>
      </div>

    </section>
  </div>

  <!-- Toast container -->
  <div id="toast-container" class="fixed bottom-4 right-4 space-y-2 z-50"></div>

  <!-- ‚úÖ EDIT MODAL -->
  <div id="edit-modal" class="fixed inset-0 hidden z-50">
    <div id="edit-backdrop" class="absolute inset-0 bg-black/40"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-2xl bg-white rounded-2xl shadow-xl border overflow-hidden">
        <div class="p-4 border-b flex items-center justify-between">
          <div>
            <div class="text-lg font-black">Edit Menu Item</div>
            <div id="edit-subtitle" class="text-xs text-neutral-500"></div>
          </div>
          <button id="edit-close" class="px-3 py-2 rounded-lg border text-sm bg-white hover:bg-neutral-100">
            Close
          </button>
        </div>

        <form id="edit-form" class="p-4 grid md:grid-cols-6 gap-3">
          <input type="hidden" name="id" />

          <label class="md:col-span-3 text-sm">
            <div class="text-xs text-neutral-600 mb-1">Name (EN)</div>
            <input name="name_en" required class="border p-2 rounded w-full" />
          </label>

          <label class="md:col-span-3 text-sm">
            <div class="text-xs text-neutral-600 mb-1">Name (CN)</div>
            <input name="name_cn" required class="border p-2 rounded w-full" />
          </label>

          <label class="md:col-span-2 text-sm">
            <div class="text-xs text-neutral-600 mb-1">Price</div>
            <input name="price" required type="number" step="0.01" class="border p-2 rounded w-full" />
          </label>

          <label class="md:col-span-2 text-sm">
            <div class="text-xs text-neutral-600 mb-1">Category</div>
            <input name="category" class="border p-2 rounded w-full" />
          </label>

          <label class="md:col-span-2 text-sm flex items-end gap-2">
            <input type="checkbox" name="is_available" class="h-4 w-4" />
            <span class="text-sm">Available</span>
          </label>

          <label class="md:col-span-6 text-sm">
            <div class="text-xs text-neutral-600 mb-1">Image URL (path or full URL)</div>
            <input name="image_url" class="border p-2 rounded w-full" placeholder="/menu/three-combo-marinated.jpg" />
          </label>

          <div class="md:col-span-6 flex items-center justify-between gap-2 pt-2">
            <div class="text-xs text-neutral-500">
              This updates the existing record (old orders stay safe).
            </div>
            <button class="px-4 py-2 rounded-lg bg-black text-white text-sm font-semibold">
              Save Changes
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

<script>
  const API_BASE = "/api";
  const ASSET_BASE = location.origin;

  let token = localStorage.getItem("xiangyee_token");

  const loginSection   = document.getElementById("login-section");
  const contentSection = document.getElementById("content-section");
  const logoutBtn      = document.getElementById("logout-btn");
  const msg            = document.getElementById("login-msg");

  const money = (n) => `$${Number(n || 0).toFixed(2)}`;

  function resolveImageUrl(url) {
    if (!url) return "";
    const s = String(url).trim();
    if (!s) return "";
    if (s.startsWith("http://") || s.startsWith("https://")) return s;
    const path = s.startsWith("/") ? s : `/${s}`;
    return `${ASSET_BASE}${path}`;
  }

  function showToast(text, type = "info") {
    const container = document.getElementById("toast-container");
    const div = document.createElement("div");
    const color = type === "error" ? "bg-red-600" :
                  type === "success" ? "bg-green-600" : "bg-neutral-900";

    div.className = `${color} text-white px-4 py-2 rounded-xl shadow-lg text-sm flex items-center gap-2 toast-enter`;
    div.innerHTML = `<span>${text}</span>`;
    container.appendChild(div);

    requestAnimationFrame(() => div.classList.add("toast-enter-active"));

    setTimeout(() => {
      div.classList.remove("toast-enter-active");
      div.style.opacity = "0";
      div.style.transform = "translateY(10px)";
      setTimeout(() => div.remove(), 250);
    }, 4000);
  }

  function setAuthedUI(authed) {
    loginSection.classList.toggle("hidden", authed);
    contentSection.classList.toggle("hidden", !authed);
    logoutBtn.classList.toggle("hidden", !authed);
  }

  function doLogout() {
    token = null;
    localStorage.removeItem("xiangyee_token");
    clearAutoRefresh();
    setAuthedUI(false);
  }

  async function login(e) {
    e.preventDefault();
    msg.textContent = "";

    const form = e.target;
    const payload = {
      username: form.username.value.trim(),
      password: form.password.value.trim()
    };

    try {
      const res = await fetch(`${API_BASE}/auth/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        msg.textContent = err.error || err.message || "Login failed";
        return;
      }

      const data = await res.json();
      if (!data.token) {
        msg.textContent = "Login succeeded but no token returned";
        return;
      }

      token = data.token;
      localStorage.setItem("xiangyee_token", token);

      setAuthedUI(true);
      loadOrders(true);
      loadReservations(true);
      loadMenuAdmin(true);
      setupAutoRefresh();

    } catch (err) {
      console.error(err);
      msg.textContent = "Cannot reach backend";
    }
  }

  async function authedFetch(url, opts={}) {
    const res = await fetch(url, {
      ...opts,
      headers: {
        ...(opts.headers || {}),
        "Authorization": `Bearer ${token}`
      }
    });

    if (res.status === 401) {
      doLogout();
      alert("Session expired. Please login again.");
      throw new Error("Unauthorized");
    }
    return res;
  }

  function safeParseItems(items) {
    if (!items) return [];
    if (Array.isArray(items)) return items;
    try { return JSON.parse(items); } catch { return []; }
  }

  // ====== LIVE TRACKING (orders/reservations) ======
  let lastOrderIds = new Set();
  let lastResIds   = new Set();
  let unreadOrderIds = new Set();
  let unreadResIds   = new Set();

  function applyUnreadStyle(cardEl, isUnread) {
    cardEl.classList.toggle("ring-2", isUnread);
    cardEl.classList.toggle("ring-amber-400", isUnread);
    cardEl.classList.toggle("border-amber-400", isUnread);

    if (isUnread) {
      cardEl.classList.remove("bg-neutral-50");
      cardEl.classList.add("bg-amber-50");
    } else {
      cardEl.classList.remove("bg-amber-50");
      cardEl.classList.add("bg-neutral-50");
      cardEl.classList.remove("border-amber-400");
    }
  }

  let ordersInterval = null;
  let resInterval    = null;

  // ====== TABS ======
  const tabOrdersBtn = document.getElementById("tab-orders");
  const tabResBtn    = document.getElementById("tab-res");
  const tabMenuBtn   = document.getElementById("tab-menu");

  const panelOrders  = document.getElementById("panel-orders");
  const panelRes     = document.getElementById("panel-res");
  const panelMenu    = document.getElementById("panel-menu");

  let activeTab = "orders";

  function styleTab(btn, active) {
    btn.classList.toggle("bg-black", active);
    btn.classList.toggle("text-white", active);
    btn.classList.toggle("bg-neutral-100", !active);
    btn.classList.toggle("text-neutral-900", !active);
  }

  function setActiveTab(tab) {
    activeTab = tab;
    panelOrders.classList.toggle("hidden", tab !== "orders");
    panelRes.classList.toggle("hidden", tab !== "reservations");
    panelMenu.classList.toggle("hidden", tab !== "menu");
    styleTab(tabOrdersBtn, tab === "orders");
    styleTab(tabResBtn, tab === "reservations");
    styleTab(tabMenuBtn, tab === "menu");
  }

  setActiveTab("orders");
  tabOrdersBtn.onclick = () => setActiveTab("orders");
  tabResBtn.onclick    = () => setActiveTab("reservations");
  tabMenuBtn.onclick   = () => setActiveTab("menu");

  // ====== ORDERS UI ======
  function orderCard(o) {
    const div = document.createElement("div");
    div.className = "p-4 rounded-xl border bg-neutral-50";
    applyUnreadStyle(div, unreadOrderIds.has(o.id));

    const itemsArr = safeParseItems(o.items);

    div.innerHTML = `
      <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
        <div>
          <div class="font-semibold">
            Order No: <span class="font-black">${o.order_no || `#${o.id}`}</span>
            ‚Äî ${o.customer_name} (${o.customer_phone})
          </div>
          <div class="text-sm text-neutral-600">
            Type: ${o.order_type}
            ${o.table_no ? `‚Ä¢ Table ${o.table_no}` : ""}
            ‚Ä¢ Total ${money(o.total_amount)}
          </div>
          <div class="text-xs text-neutral-500">Status: ${o.status}</div>
          ${o.notes ? `<div class="text-xs text-neutral-500 mt-1">Notes: ${o.notes}</div>` : ""}
        </div>

        <select class="border p-1 rounded text-sm w-full md:w-auto">
          ${["pending","ready","collected"]
            .map(s => `<option value="${s}" ${s===o.status?"selected":""}>${s}</option>`).join("")}
        </select>
      </div>

      <div class="mt-3 bg-white p-3 rounded-lg border text-sm">
        <div class="font-semibold mb-2">Items</div>
        ${
          itemsArr.length
          ? itemsArr.map(it => `
              <div class="flex justify-between border-b py-1 last:border-b-0">
                <span>${it.name_en || it.name || ("Item #" + it.menu_item_id)}</span>
                <span>x${it.quantity}</span>
              </div>
            `).join("")
          : `<div class="text-neutral-500 text-xs">No items recorded.</div>`
        }
      </div>
    `;

    const sel = div.querySelector("select");
    sel.onchange = async () => {
      await authedFetch(`${API_BASE}/orders/${o.id}`, {
        method: "PUT",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ status: sel.value })
      });
      unreadOrderIds.delete(o.id);
      loadOrders(true);
    };

    return div;
  }

  async function loadOrders(initial = false) {
    const root = document.getElementById("orders-list");
    if (initial) root.innerHTML = `<div class="text-sm text-neutral-500">Loading...</div>`;

    try {
      const res = await authedFetch(`${API_BASE}/orders/admin`);
      if (!res.ok) throw new Error("Failed to load orders");
      let data = await res.json();

      data.sort((a, b) => {
        const da = a.created_at ? new Date(a.created_at) : new Date(0);
        const db = b.created_at ? new Date(b.created_at) : new Date(0);
        return db - da || (b.id - a.id);
      });

      root.innerHTML = "";
      if (!data.length) {
        root.innerHTML = `<div class="text-sm text-neutral-500">No orders yet.</div>`;
        lastOrderIds = new Set();
        return;
      }

      const currentIds = new Set(data.map(o => o.id));
      if (!initial) {
        const newOnes = data.filter(o => !lastOrderIds.has(o.id));
        if (newOnes.length) {
          newOnes.forEach(o => unreadOrderIds.add(o.id));
          showToast(`üßæ New order(s): ${newOnes.map(o => o.order_no || `#${o.id}`).join(", ")}`, "success");
          if (activeTab === "reservations") setActiveTab("orders");
        }
      }

      lastOrderIds = currentIds;
      data.forEach(o => root.appendChild(orderCard(o)));
    } catch (err) {
      console.error(err);
      root.innerHTML = `<div class="text-sm text-red-600">Error loading orders.</div>`;
    }
  }

  // ====== RESERVATIONS UI ======
  function resCard(r) {
    const div = document.createElement("div");
    div.className = "p-4 rounded-xl border bg-neutral-50";
    applyUnreadStyle(div, unreadResIds.has(r.id));

    div.innerHTML = `
      <div class="flex flex-col md:flex-row md:justify-between gap-3">
        <div>
          <div class="font-semibold">${r.customer_name} (${r.customer_phone})</div>
          <div class="text-sm text-neutral-600">
            ${r.reservation_date || "-"} ‚Ä¢ ${r.reservation_time || "-"} ‚Ä¢ Pax ${r.pax}
          </div>
          <div class="text-xs text-neutral-500">Status: ${r.status}</div>
          ${r.notes ? `<div class="text-xs text-neutral-500 mt-1">Notes: ${r.notes}</div>` : ""}
        </div>

        <select class="border p-1 rounded text-sm w-full md:w-auto">
          ${["pending","confirmed","seated","completed","cancelled"]
            .map(s => `<option value="${s}" ${s===r.status?"selected":""}>${s}</option>`).join("")}
        </select>
      </div>
    `;

    const sel = div.querySelector("select");
    sel.onchange = async () => {
      await authedFetch(`${API_BASE}/reservations/${r.id}`, {
        method: "PUT",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ status: sel.value })
      });
      unreadResIds.delete(r.id);
      loadReservations(true);
    };

    return div;
  }

  async function loadReservations(initial = false) {
    const root = document.getElementById("res-list");
    if (initial) root.innerHTML = `<div class="text-sm text-neutral-500">Loading...</div>`;

    try {
      const res = await authedFetch(`${API_BASE}/reservations/admin`);
      if (!res.ok) throw new Error("Failed to load reservations");
      let data = await res.json();

      root.innerHTML = "";
      if (!data.length) {
        root.innerHTML = `<div class="text-sm text-neutral-500">No reservations yet.</div>`;
        lastResIds = new Set();
        return;
      }

      const currentIds = new Set(data.map(r => r.id));
      if (!initial) {
        const newRes = data.filter(r => !lastResIds.has(r.id));
        if (newRes.length) {
          newRes.forEach(r => unreadResIds.add(r.id));
          showToast(`New reservation(s): ${newRes.map(r => `${r.reservation_date} ${r.reservation_time} ‚Ä¢ ${r.customer_name}`).join(" | ")}`, "success");
          if (activeTab === "orders") setActiveTab("reservations");
        }
      }

      lastResIds = currentIds;
      data.forEach(r => root.appendChild(resCard(r)));
    } catch (err) {
      console.error(err);
      root.innerHTML = `<div class="text-sm text-red-600">Error loading reservations.</div>`;
    }
  }

  // ====== MENU ADMIN UI ======
  let allMenuItems = [];

  function setMenuCount(n) {
    const el = document.getElementById("menu-count");
    if (el) el.textContent = `${n} item${n === 1 ? "" : "s"}`;
  }

  function buildCategoryDropdown(items) {
    const select = document.getElementById("menu-category");
    if (!select) return;

    const cats = Array.from(new Set(items.map(x => x.category).filter(Boolean)))
      .sort((a,b)=>String(a).localeCompare(String(b)));

    const current = select.value;
    select.innerHTML = `<option value="">All Categories</option>` +
      cats.map(c => `<option value="${c}">${c}</option>`).join("");

    if (cats.includes(current)) select.value = current;
  }

  function getMenuFilters() {
    const q = (document.getElementById("menu-search")?.value || "").trim().toLowerCase();
    const cat = document.getElementById("menu-category")?.value || "";
    const avail = document.getElementById("menu-availability")?.value || "all";
    return { q, cat, avail };
  }

  function applyMenuFilters(items) {
    const { q, cat, avail } = getMenuFilters();
    return items.filter(m => {
      if (cat && m.category !== cat) return false;
      if (avail === "available" && !m.is_available) return false;
      if (avail === "unavailable" && m.is_available) return false;

      if (q) {
        const en = String(m.name_en || "").toLowerCase();
        const cn = String(m.name_cn || "").toLowerCase();
        if (!en.includes(q) && !cn.includes(q)) return false;
      }
      return true;
    });
  }

  function escapeHtml(s) {
    return String(s || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  // ‚úÖ Edit modal wiring
  const editModal = document.getElementById("edit-modal");
  const editClose = document.getElementById("edit-close");
  const editBackdrop = document.getElementById("edit-backdrop");
  const editForm  = document.getElementById("edit-form");
  const editSubtitle = document.getElementById("edit-subtitle");

  function openEditModal(item) {
    editForm.id.value = item.id;
    editForm.name_en.value = item.name_en || "";
    editForm.name_cn.value = item.name_cn || "";
    editForm.price.value = Number(item.price || 0).toFixed(2);
    editForm.category.value = item.category || "";
    editForm.image_url.value = item.image_url || "";
    editForm.is_available.checked = !!item.is_available;

    editSubtitle.textContent = `ID: ${item.id}`;
    editModal.classList.remove("hidden");
  }
  function closeEditModal() {
    editModal.classList.add("hidden");
  }
  editClose.onclick = closeEditModal;
  editBackdrop.onclick = closeEditModal;

  editForm.onsubmit = async (e) => {
    e.preventDefault();
    const id = editForm.id.value;

    const payload = {
      name_en: editForm.name_en.value.trim(),
      name_cn: editForm.name_cn.value.trim(),
      price: Number(editForm.price.value),
      category: (editForm.category.value || "Main Dishes").trim(),
      image_url: (editForm.image_url.value || "").trim() || null,
      is_available: !!editForm.is_available.checked
    };

    try {
      const res = await authedFetch(`${API_BASE}/menu/admin/${id}`, {
        method: "PUT",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        showToast(err.error || err.message || "Failed to update item", "error");
        return;
      }

      showToast("Menu item updated", "success");
      closeEditModal();
      loadMenuAdmin(true);
    } catch (err) {
      console.error(err);
      showToast("Error updating item", "error");
    }
  };

  function menuCard(m) {
    const div = document.createElement("div");
    div.className = "p-4 rounded-xl border bg-neutral-50";

    const statusPill = m.is_available
      ? `<span class="text-green-700 font-semibold">Available</span>`
      : `<span class="text-red-700 font-semibold">Unavailable</span>`;

    const imgSrc = resolveImageUrl(m.image_url);

    div.innerHTML = `
      <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
        <div class="flex gap-4">
          <div class="w-24 h-24 rounded-xl border bg-white overflow-hidden flex items-center justify-center shrink-0">
            ${
              imgSrc
                ? `<img
                    src="${imgSrc}"
                    alt="${escapeHtml(m.name_en || "Menu item")}"
                    class="w-full h-full object-cover"
                    loading="lazy"
                    onerror="this.closest('div').innerHTML='<span class=\\'text-xs text-neutral-500\\'>No image</span>'"
                  />`
                : `<span class="text-xs text-neutral-500">No image</span>`
            }
          </div>

          <div class="space-y-1">
            <div class="font-black text-lg">
              ${escapeHtml(m.name_en)} <span class="font-semibold text-neutral-500">(${escapeHtml(m.name_cn)})</span>
            </div>
            <div class="text-sm text-neutral-600">
              ${escapeHtml(m.category)} ‚Ä¢ ${money(m.price)} ‚Ä¢ ${statusPill}
            </div>
            ${m.image_url ? `<div class="text-xs text-neutral-500 break-all">Path: ${escapeHtml(m.image_url)}</div>` : ""}
          </div>
        </div>

        <div class="flex gap-2 md:justify-end">
          <button class="edit px-3 py-2 rounded-lg border text-sm bg-white hover:bg-neutral-100">Edit</button>

          <button class="toggle px-3 py-2 rounded-lg border text-sm bg-white hover:bg-neutral-100">
            ${m.is_available ? "Set Unavailable" : "Set Available"}
          </button>

          <button class="del hidden px-3 py-2 rounded-lg border text-sm bg-white hover:bg-neutral-100">
            Remove
          </button>
        </div>
      </div>
    `;

    // ‚úÖ Edit
    div.querySelector(".edit").onclick = () => openEditModal(m);

    // Toggle availability
    div.querySelector(".toggle").onclick = async () => {
      await authedFetch(`${API_BASE}/menu/admin/${m.id}`, {
        method: "PUT",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ is_available: !m.is_available })
      });
      showToast("Menu item updated", "success");
      loadMenuAdmin(true);
    };

    // ‚úÖ SAFE REMOVE: hide only (no breaking old orders)
    div.querySelector(".del").onclick = async () => {
      if (!confirm(`Remove "${m.name_en}"? (This will hide it)`)) return;

      await authedFetch(`${API_BASE}/menu/admin/${m.id}`, {
        method: "PUT",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ is_available: false })
      });

      showToast("Menu item hidden", "success");
      loadMenuAdmin(true);
    };

    return div;
  }

  function renderMenuList(items) {
    const root = document.getElementById("menu-list");
    if (!root) return;

    root.innerHTML = "";
    if (!items.length) {
      root.innerHTML = `<div class="text-sm text-neutral-500">No matching menu items.</div>`;
      setMenuCount(0);
      return;
    }

    items.forEach(m => root.appendChild(menuCard(m)));
    setMenuCount(items.length);
  }

  function refreshMenuView() {
    const sorted = [...allMenuItems].sort((a,b) => {
      const c = String(a.category || "").localeCompare(String(b.category || ""));
      if (c !== 0) return c;
      return String(a.name_en || "").localeCompare(String(b.name_en || ""));
    });

    buildCategoryDropdown(sorted);
    const filtered = applyMenuFilters(sorted);
    renderMenuList(filtered);
  }

  async function loadMenuAdmin(initial=false) {
    const root = document.getElementById("menu-list");
    if (initial && root) root.innerHTML = `<div class="text-sm text-neutral-500">Loading...</div>`;

    try {
      const res = await authedFetch(`${API_BASE}/menu/admin`);
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.message || err.error || "Failed to load menu");
      }

      allMenuItems = await res.json();
      refreshMenuView();
    } catch (err) {
      console.error(err);
      if (root) root.innerHTML = `<div class="text-sm text-red-600">Error loading menu: ${err.message}</div>`;
    }
  }

  // ====== ADD MENU ITEM ======
  const menuForm = document.getElementById("menu-form");
  menuForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const f = e.target;

    const payload = {
      name_en: f.name_en.value.trim(),
      name_cn: f.name_cn.value.trim(),
      price: Number(f.price.value),
      category: (f.category.value || "Main Dishes").trim(),
      image_url: (f.image_url.value || "").trim() || null,
      is_available: !!f.is_available.checked
    };

    try {
      const res = await authedFetch(`${API_BASE}/menu/admin`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        showToast(err.error || err.message || "Failed to add item", "error");
        return;
      }

      f.reset();
      f.is_available.checked = true;
      showToast("Menu item added", "success");
      loadMenuAdmin(true);
    } catch (err) {
      console.error(err);
      showToast("Error adding item", "error");
    }
  });

  // filters
  document.getElementById("menu-refresh").onclick = () => loadMenuAdmin(true);
  document.getElementById("menu-search").addEventListener("input", refreshMenuView);
  document.getElementById("menu-category").addEventListener("change", refreshMenuView);
  document.getElementById("menu-availability").addEventListener("change", refreshMenuView);

  // ====== AUTO REFRESH ======
  function setupAutoRefresh() {
    clearAutoRefresh();
    ordersInterval = setInterval(() => { if (token) loadOrders(false); }, 5000);
    resInterval = setInterval(() => { if (token) loadReservations(false); }, 5000);
  }
  function clearAutoRefresh() {
    if (ordersInterval) clearInterval(ordersInterval);
    if (resInterval) clearInterval(resInterval);
    ordersInterval = null;
    resInterval = null;
  }

  // ====== WIRE EVENTS ======
  document.getElementById("login-form").addEventListener("submit", login);
  logoutBtn.onclick = doLogout;

  if (token) {
    setAuthedUI(true);
    loadOrders(true);
    loadReservations(true);
    loadMenuAdmin(true);
    setupAutoRefresh();
  } else {
    setAuthedUI(false);
  }
</script>
</body>
</html>
