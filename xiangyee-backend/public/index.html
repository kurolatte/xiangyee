<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Xiangyee Hunan Cuisine | Bold, Fiery, Authentic</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
          colors: { brand: { red: '#dc2626' } }
        }
      }
    }
  </script>

  <style>
    html { scroll-behavior: smooth; }
    .shadow-soft { box-shadow: 0 10px 30px rgba(0,0,0,.08); }
    .no-scrollbar::-webkit-scrollbar { display:none; }
    .no-scrollbar { -ms-overflow-style:none; scrollbar-width:none; }
  </style>
</head>

<body class="bg-neutral-50 text-neutral-900 font-sans">

<!-- HERO -->
<section class="bg-white">
  <div class="w-full h-[80vh] max-h-[900px] overflow-hidden">
    <img src="/images/hero.png" class="w-full h-full object-cover" />
  </div>
</section>

<!-- MENU -->
<section id="menu" class="max-w-6xl mx-auto px-4 py-16">
  <h2 class="text-4xl font-extrabold mb-8">Menu</h2>
  <div id="menu-sections">Loading…</div>
</section>

<!-- CART DRAWER -->
<aside id="cart-drawer"
  class="fixed right-0 top-0 h-full w-full sm:w-[420px] bg-white border-l border-neutral-200 shadow-2xl translate-x-full transition-transform duration-300 z-[60] flex flex-col">

  <div class="p-4 border-b flex justify-between">
    <h3 class="font-bold">Your Cart</h3>
    <button onclick="closeCart()">✕</button>
  </div>

  <div id="cart-items" class="flex-1 overflow-y-auto p-4"></div>

  <form id="order-form" class="p-4 border-t space-y-2">
    <input name="customer_name" required placeholder="Name" class="w-full border p-2 rounded">
    <input name="customer_phone" required placeholder="Phone (8 or 9xxxxxxx)"
           pattern="[89][0-9]{7}" maxlength="8" class="w-full border p-2 rounded">

    <select name="order_type" class="w-full border p-2 rounded">
      <option value="takeaway">Takeaway</option>
      <option value="dine_in">Dine In</option>
    </select>

    <input name="table_no" placeholder="Table No (if dine-in)" class="w-full border p-2 rounded">
    <textarea name="notes" placeholder="Notes" class="w-full border p-2 rounded"></textarea>

    <div class="flex justify-between font-bold">
      <span>Total</span>
      <span id="cart-total">$0.00</span>
    </div>

    <button class="w-full bg-brand-red text-white py-3 rounded font-semibold">
      Place Order
    </button>
  </form>
</aside>

<div id="drawer-backdrop" class="fixed inset-0 bg-black/40 hidden z-[55]" onclick="closeCart()"></div>

<script>
/* ================= CONFIG ================= */
const API_BASE = "/api";
const $ = s => document.querySelector(s);
const money = n => `$${Number(n||0).toFixed(2)}`;
const asInt = v => Number.isFinite(Number(v)) ? Number(v) : null;

/* ================= STATE ================= */
let menuItems = [];
let cart = [];

/* ================= CART STORAGE ================= */
function saveCart(){ localStorage.setItem("cart", JSON.stringify(cart)); }
function loadCart(){
  try { cart = JSON.parse(localStorage.getItem("cart")) || []; }
  catch { cart = []; }

  cart = cart.map(c => ({
    ...c,
    id: asInt(c.id),
    qty: asInt(c.qty),
    price: Number(c.price)
  })).filter(c => c.id && c.qty > 0);
}

/* ================= CART ================= */
function addToCart(item){
  const id = asInt(item.id);
  const price = Number(item.price);

  let existing = cart.find(c => c.id === id);
  if(existing) existing.qty++;
  else cart.push({ id, name:item.name_en, price, image:item.image_url, qty:1 });

  saveCart(); renderCart(); openCart();
}

function renderCart(){
  const root = $("#cart-items");
  root.innerHTML = "";

  if(!cart.length){
    root.innerHTML = "<p class='text-sm text-neutral-500'>Cart empty</p>";
    $("#cart-total").textContent = money(0);
    return;
  }

  cart.forEach(c=>{
    const row = document.createElement("div");
    row.className="flex justify-between py-2 border-b";
    row.innerHTML = `
      <div>${c.name} x${c.qty}</div>
      <div>${money(c.price*c.qty)}</div>
    `;
    root.appendChild(row);
  });

  $("#cart-total").textContent = money(cart.reduce((s,c)=>s+c.price*c.qty,0));
}

function openCart(){
  $("#cart-drawer").classList.remove("translate-x-full");
  $("#drawer-backdrop").classList.remove("hidden");
}
function closeCart(){
  $("#cart-drawer").classList.add("translate-x-full");
  $("#drawer-backdrop").classList.add("hidden");
}

/* ================= MENU ================= */
async function fetchMenu(){
  const res = await fetch(`${API_BASE}/menu`);
  menuItems = await res.json();
  renderMenu();
}

function renderMenu(){
  const root = $("#menu-sections");
  root.innerHTML = "";

  menuItems.forEach(item=>{
    const card = document.createElement("div");
    card.className="border rounded p-4 mb-3 flex justify-between";
    card.innerHTML = `
      <div>
        <div class="font-semibold">${item.name_en}</div>
        <div class="text-sm text-neutral-500">${item.name_cn}</div>
      </div>
      <div class="text-right">
        <div class="font-bold">${money(item.price)}</div>
        <button class="mt-2 bg-brand-red text-white px-3 py-1 rounded">Add</button>
      </div>
    `;
    card.querySelector("button").onclick=()=>addToCart(item);
    root.appendChild(card);
  });
}

/* ================= ORDER ================= */
$("#order-form").addEventListener("submit", async e=>{
  e.preventDefault();

  if(!cart.length) return alert("Cart empty");

  const f = e.target;
  const payload = {
    customer_name: f.customer_name.value.trim(),
    customer_phone: f.customer_phone.value.trim(),
    order_type: f.order_type.value,
    table_no: f.table_no.value || null,
    notes: f.notes.value || null,
    items: cart.map(c=>({ menu_item_id:c.id, quantity:c.qty }))
  };

  const res = await fetch(`${API_BASE}/orders`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });

  if(!res.ok){
    alert(await res.text());
    return;
  }

  cart=[];
  saveCart();
  renderCart();
  closeCart();
  alert("Order placed successfully!");
});

/* ================= INIT ================= */
loadCart();
renderCart();
fetchMenu();
</script>

</body>
</html>
